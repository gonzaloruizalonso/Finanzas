<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gonzalo Finance OS - Mobile Fixed</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #0b0f19; color: #cbd5e1; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        .glass { 
            background: rgba(30, 41, 59, 0.6); 
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1); 
            border-radius: 16px; 
        }
        
        /* FIX MÓVIL: Evita que el gráfico rompa el ancho */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            min-width: 0; /* CRÍTICO PARA MÓVIL */
        }

        /* En pantallas pequeñas, altura menor */
        @media (max-width: 768px) {
            .chart-container { height: 250px; }
            h1 { font-size: 1.25rem; }
        }
    </style>
</head>
<body class="p-3 md:p-6 pb-24 max-w-7xl mx-auto selection:bg-blue-500 selection:text-white overflow-x-hidden">

    <div x-data="financeOS()" x-init="init()" class="space-y-6">

        <header class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
            <div class="flex items-center gap-3 w-full md:w-auto">
                <div class="bg-blue-600/20 p-2 rounded-xl border border-blue-500/30">
                    <i data-lucide="activity" class="text-blue-400 w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="font-bold text-white tracking-tight">Finance OS</h1>
                    <p class="text-xs text-gray-500">Sincronizado con Supabase</p>
                </div>
            </div>
            
            <button @click="showAddModal = true" class="w-full md:w-auto bg-blue-600 active:scale-95 text-white px-4 py-3 rounded-xl font-bold shadow-lg shadow-blue-900/40 flex justify-center items-center gap-2 transition-all">
                <i data-lucide="plus" class="w-5 h-5"></i>
                <span>Añadir</span>
            </button>
        </header>

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
            <div class="glass p-4">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Patrimonio</span>
                    <i data-lucide="wallet" class="w-4 h-4 text-emerald-400"></i>
                </div>
                <div class="text-2xl md:text-3xl font-mono font-bold text-white" x-text="formatMoney(kpi.totalBalance)"></div>
            </div>

            <div class="glass p-4">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Inversión</span>
                    <i data-lucide="pie-chart" class="w-4 h-4 text-purple-400"></i>
                </div>
                <div class="text-2xl md:text-3xl font-mono font-bold text-purple-400" x-text="formatMoney(kpi.totalInvested)"></div>
            </div>

            <div class="glass p-4">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Salidas este mes</span>
                    <i data-lucide="flame" class="w-4 h-4 text-red-400"></i>
                </div>
                <div class="text-2xl md:text-3xl font-mono font-bold text-red-400" x-text="formatMoney(kpi.monthExpenses)"></div>
                <div class="text-[10px] text-gray-500 mt-1">Fijos + Variables</div>
            </div>

            <div class="glass p-4">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Capacidad Ahorro</span>
                    <i data-lucide="piggy-bank" class="w-4 h-4 text-blue-400"></i>
                </div>
                <div class="text-2xl md:text-3xl font-mono font-bold text-blue-400" x-text="formatMoney(kpi.monthSavings)"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="glass p-4 lg:col-span-2 flex flex-col">
                <h3 class="font-bold text-sm mb-4 flex items-center gap-2 text-white">
                    <i data-lucide="calendar" class="text-blue-400 w-4 h-4"></i> Proyección Mensual (Real + Fijos)
                </h3>
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <div class="glass p-4 flex flex-col">
                <h3 class="font-bold text-sm mb-4 flex items-center gap-2 text-white">
                    <i data-lucide="layers" class="text-emerald-400 w-4 h-4"></i> Cuentas
                </h3>
                <div class="chart-container" style="height: 250px;">
                    <canvas id="distributionChart"></canvas>
                </div>
                <div class="mt-4 space-y-2">
                    <template x-for="acc in accounts" :key="acc.id">
                        <div class="flex justify-between text-xs border-b border-gray-700 pb-1 last:border-0">
                            <span x-text="acc.name" class="text-gray-400"></span>
                            <span x-text="formatMoney(acc.current_balance)" class="font-mono text-white"></span>
                        </div>
                    </template>
                </div>
            </div>

            <div class="glass p-4">
                <h3 class="font-bold text-sm mb-2 flex items-center gap-2 text-white">
                    <i data-lucide="radar" class="text-purple-400 w-4 h-4"></i> Categorías
                </h3>
                <div class="chart-container">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>

            <div class="glass p-4 lg:col-span-2">
                <h3 class="font-bold text-sm mb-2 flex items-center gap-2 text-white">
                    <i data-lucide="trending-up" class="text-green-400 w-4 h-4"></i> Tendencia Patrimonio
                </h3>
                <div class="chart-container">
                    <canvas id="wealthChart"></canvas>
                </div>
            </div>
        </div>

        <div class="glass p-4 overflow-hidden">
            <h3 class="font-bold text-sm mb-4 text-gray-400 uppercase tracking-widest">Tus Gastos Fijos (Tabla Recurring)</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm whitespace-nowrap">
                    <thead class="text-xs text-gray-500 uppercase bg-gray-800/50">
                        <tr>
                            <th class="p-3">Día</th>
                            <th class="p-3">Nombre</th>
                            <th class="p-3 text-right">Importe</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800">
                        <template x-for="rec in recurringData" :key="rec.id">
                            <tr class="hover:bg-white/5 transition">
                                <td class="p-3 font-mono text-blue-400" x-text="rec.day_of_month"></td>
                                <td class="p-3 text-white" x-text="rec.name"></td>
                                <td class="p-3 text-right font-mono" 
                                    :class="rec.type === 'income' ? 'text-emerald-400' : 'text-red-400'"
                                    x-text="formatMoney(rec.amount)">
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <div x-show="showAddModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-end md:items-center justify-center p-0 md:p-4" x-transition style="display: none;">
            <div class="bg-gray-900 border-t md:border border-gray-700 w-full max-w-lg rounded-t-2xl md:rounded-2xl p-6 shadow-2xl relative h-[80vh] md:h-auto overflow-y-auto">
                <button @click="showAddModal = false" class="absolute top-4 right-4 text-gray-500 p-2"><i data-lucide="x"></i></button>
                
                <h2 class="text-xl font-bold mb-6 text-white">Añadir</h2>
                
                <div class="flex gap-2 mb-6 bg-gray-800 p-1 rounded-lg">
                    <button @click="mode = 'transaction'" :class="mode==='transaction' ? 'bg-blue-600 text-white' : 'text-gray-400'" class="flex-1 py-2 rounded-md text-sm font-bold transition">Movimiento Puntual</button>
                    <button @click="mode = 'recurring'" :class="mode==='recurring' ? 'bg-purple-600 text-white' : 'text-gray-400'" class="flex-1 py-2 rounded-md text-sm font-bold transition">Regla Recurrente</button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500">Cantidad</label>
                        <input type="number" x-model="form.amount" placeholder="0.00" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white text-lg font-mono outline-none focus:border-blue-500">
                    </div>

                    <div>
                        <label class="text-xs text-gray-500">Concepto</label>
                        <input type="text" x-model="form.name" placeholder="Ej: Netflix, Nómina..." class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white outline-none focus:border-blue-500">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-500">Tipo</label>
                            <select x-model="form.type" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white outline-none">
                                <option value="expense">Gasto (-)</option>
                                <option value="income">Ingreso (+)</option>
                                <option value="investment">Inversión (ETF)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Cuenta</label>
                            <select x-model="form.account_id" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white outline-none">
                                <template x-for="acc in accounts" :key="acc.id">
                                    <option :value="acc.id" x-text="acc.name"></option>
                                </template>
                            </select>
                        </div>
                    </div>

                    <div x-show="mode === 'transaction'" class="grid grid-cols-1">
                        <label class="text-xs text-gray-500">Fecha</label>
                        <input type="date" x-model="form.date" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white outline-none">
                    </div>

                    <div x-show="mode === 'recurring'" class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-500">Día del mes (1-31)</label>
                            <input type="number" x-model="form.day_of_month" max="31" min="1" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white outline-none">
                        </div>
                         <div>
                            <label class="text-xs text-gray-500">Fin (Opcional)</label>
                            <input type="date" x-model="form.end_date" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white outline-none">
                        </div>
                    </div>

                    <button @click="submit()" class="w-full py-4 mt-4 rounded-xl font-bold text-white shadow-lg transition" 
                        :class="mode === 'transaction' ? 'bg-blue-600 hover:bg-blue-500' : 'bg-purple-600 hover:bg-purple-500'">
                        Guardar
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // ⬇️ TUS CLAVES ⬇️
        const SUPABASE_URL = 'https://pfohhjmeomixhzktwggl.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_t8scoBrGD4XNEozDZD3ZrA_XCl1kRaE';
        // ==========================================

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Colores
        const c = { green: '#10b981', red: '#ef4444', blue: '#3b82f6', purple: '#a855f7', slate: '#64748b' };

        function financeOS() {
            return {
                showAddModal: false,
                mode: 'transaction', // 'transaction' o 'recurring'
                accounts: [],
                transactions: [], // Historial real
                recurringData: [], // Reglas fijas
                mixedData: [], // MEZCLA para gráficos
                
                kpi: { totalBalance: 0, totalInvested: 0, monthSavings: 0, monthExpenses: 0 },
                
                form: { 
                    amount: '', name: '', type: 'expense', account_id: '', 
                    date: new Date().toISOString().split('T')[0], 
                    day_of_month: '', end_date: '' // Corrección nombre columna
                },

                async init() {
                    await this.loadData();
                    lucide.createIcons();
                },

                async loadData() {
                    // 1. CARGA PARALELA DE TODO
                    const [accs, txs, recs] = await Promise.all([
                        db.from('accounts').select('*').order('name'),
                        db.from('transactions').select('*').order('date', {ascending: true}),
                        db.from('recurring').select('*') // Cargamos tus reglas fijas
                    ]);

                    this.accounts = accs.data || [];
                    this.transactions = txs.data || [];
                    this.recurringData = recs.data || [];

                    // 2. CALCULAR SALDOS REALES
                    let globalBalance = 0;
                    this.accounts = this.accounts.map(acc => {
                        const accTxs = this.transactions.filter(t => t.account_id === acc.id);
                        const sum = accTxs.reduce((a, b) => a + Number(b.amount), 0);
                        const total = (Number(acc.initial_balance) || 0) + sum;
                        globalBalance += total;
                        return { ...acc, current_balance: total };
                    });
                    this.kpi.totalBalance = globalBalance;

                    // 3. GENERAR PROYECCIÓN (MAGIA PARA GRÁFICOS)
                    // Si no hay transacciones recientes, usamos las reglas recurrentes para pintar el gráfico
                    this.generateProjection();

                    // 4. CALCULAR KPIs
                    this.calculateKPIs();
                    
                    // 5. RENDERIZAR
                    this.renderCharts();

                    // Init form
                    if(this.accounts.length && !this.form.account_id) this.form.account_id = this.accounts[0].id;
                },

                generateProjection() {
                    // Creamos "Transacciones Virtuales" basadas en tus reglas recurring para los gráficos
                    // Esto arregla que los gráficos salgan vacíos si solo tienes reglas pero no gastos hechos
                    const today = new Date();
                    const currentMonth = today.getMonth();
                    const currentYear = today.getFullYear();
                    
                    let virtualTxs = [...this.transactions]; // Empezamos con las reales

                    // Generamos proyecciones para este mes y el pasado (para que se vea algo)
                    [-1, 0, 1].forEach(offset => {
                        const targetMonth = currentMonth + offset;
                        // Ajuste simple de año (no perfecto pero sirve visualmente)
                        const year = currentYear; 
                        
                        this.recurringData.forEach(rule => {
                            // Convertir regla a "transacción falsa" para el gráfico
                            let amount = Number(rule.amount);
                            if(rule.type === 'expense' || rule.type === 'investment') amount = -Math.abs(amount);
                            
                            // Verificar fecha fin
                            if(rule.end_date && new Date(rule.end_date) < new Date(year, targetMonth, 1)) return;

                            virtualTxs.push({
                                date: new Date(year, targetMonth, rule.day_of_month || 1).toISOString(),
                                amount: amount,
                                category: rule.name,
                                type: rule.type, // Custom prop
                                isVirtual: true
                            });
                        });
                    });

                    // Ordenar por fecha
                    this.mixedData = virtualTxs.sort((a,b) => new Date(a.date) - new Date(b.date));
                },

                calculateKPIs() {
                    // Calculamos basándonos en la PROYECCIÓN de este mes
                    const now = new Date();
                    let income = 0, expense = 0, invested = 0, historicalInvested = 0;

                    // Total histórico invertido (solo real)
                    this.transactions.forEach(t => {
                        if(this.isInvestment(t)) historicalInvested += Math.abs(Number(t.amount));
                    });
                    this.kpi.totalInvested = historicalInvested;

                    // Flujo de caja del mes actual (Real + Recurrente Proyectado)
                    this.mixedData.forEach(t => {
                        const d = new Date(t.date);
                        if(d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) {
                            const amt = Number(t.amount);
                            if(amt > 0) income += amt;
                            else {
                                if(this.isInvestment(t)) {
                                    // Inversión cuenta como salida de caja pero suma patrimonio
                                } else {
                                    expense += Math.abs(amt);
                                }
                            }
                        }
                    });

                    this.kpi.monthExpenses = expense;
                    this.kpi.monthSavings = income - expense;
                },

                // --- FORM SUBMIT (CORREGIDO) ---
                async submit() {
                    if(!this.form.amount || !this.form.name) return alert("Faltan datos");

                    let payload = {};
                    let table = '';
                    
                    if (this.mode === 'transaction') {
                        // Insertar Movimiento
                        table = 'transactions';
                        let amt = Math.abs(Number(this.form.amount));
                        if(this.form.type !== 'income') amt = -amt;
                        
                        payload = {
                            account_id: this.form.account_id,
                            category: this.form.name,
                            amount: amt,
                            date: this.form.date
                        };
                    } else {
                        // Insertar Recurrente (CORREGIDO day_of_month)
                        table = 'recurring';
                        if(!this.form.day_of_month) return alert("Pon el día del mes");
                        
                        payload = {
                            name: this.form.name,
                            amount: Number(this.form.amount),
                            type: this.form.type,
                            account_id: this.form.account_id,
                            day_of_month: this.form.day_of_month, // AQUI ESTABA EL ERROR
                            end_date: this.form.end_date || null
                        };
                    }

                    const { error } = await db.from(table).insert([payload]);

                    if(error) alert("Error: " + error.message);
                    else {
                        this.showAddModal = false;
                        this.form.amount = ''; this.form.name = '';
                        this.loadData(); // Recargar
                    }
                },

                renderCharts() {
                    Chart.helpers.each(Chart.instances, (i) => i.destroy());

                    // Agrupar datos MIXTOS (Reales + Proyectados) por mes
                    const months = {};
                    const categories = {};
                    
                    this.mixedData.forEach(t => {
                        // Usamos substring para evitar errores de timezone
                        const key = t.date.substring(0, 7); // YYYY-MM
                        if(!months[key]) months[key] = { income: 0, expense: 0, invest: 0 };
                        
                        const amt = Number(t.amount);
                        if(amt > 0) months[key].income += amt;
                        else if(this.isInvestment(t)) months[key].invest += Math.abs(amt);
                        else {
                            months[key].expense += Math.abs(amt);
                            // Radar
                            const cat = t.category || 'Otros';
                            if(!categories[cat]) categories[cat] = 0;
                            categories[cat] += Math.abs(amt);
                        }
                    });

                    const labels = Object.keys(months).sort().slice(-6); // Últimos 6 meses

                    // 1. MAIN CHART
                    new Chart(document.getElementById('mainChart'), {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Ingresos', data: labels.map(l=>months[l].income), backgroundColor: c.green, borderRadius: 4 },
                                { label: 'Gastos', data: labels.map(l=>months[l].expense), backgroundColor: c.red, borderRadius: 4 },
                                { label: 'Inversión', data: labels.map(l=>months[l].invest), backgroundColor: c.purple, borderRadius: 4 }
                            ]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, // CRÍTICO PARA MÓVIL
                            scales: { 
                                x: { ticks: { color: c.slate }, grid: { display: false } },
                                y: { ticks: { color: c.slate }, grid: { color: '#1e293b' } }
                            },
                            plugins: { legend: { labels: { color: 'white' } } }
                        }
                    });

                    // 2. DISTRIBUTION
                    new Chart(document.getElementById('distributionChart'), {
                        type: 'doughnut',
                        data: {
                            labels: this.accounts.map(a => a.name),
                            datasets: [{
                                data: this.accounts.map(a => a.current_balance),
                                backgroundColor: [c.blue, c.purple, c.green],
                                borderWidth: 0
                            }]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            cutout: '70%', 
                            plugins: { legend: { display: false } } 
                        }
                    });

                    // 3. RADAR
                    const topCats = Object.entries(categories).sort((a,b)=>b[1]-a[1]).slice(0,5);
                    new Chart(document.getElementById('radarChart'), {
                        type: 'radar',
                        data: {
                            labels: topCats.map(x=>x[0]),
                            datasets: [{
                                label: 'Gastos',
                                data: topCats.map(x=>x[1]),
                                borderColor: c.purple,
                                backgroundColor: 'rgba(168, 85, 247, 0.2)'
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: { r: { grid: { color: '#334155' }, pointLabels: { color: 'white', font: {size: 10} }, ticks: { display: false } } },
                            plugins: { legend: { display: false } }
                        }
                    });
                    
                    // 4. WEALTH (Simple line)
                    // Calculamos acumulado usando solo transactions reales + initial
                    let wealth = this.accounts.reduce((s,a)=>s+(Number(a.initial_balance)||0),0);
                    // Esto es simplificado, solo muestra una linea recta proyectada basada en saldos actuales
                    // Para hacerlo real necesitaríamos historial de saldos diarios
                    new Chart(document.getElementById('wealthChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Patrimonio',
                                data: labels.map(() => wealth), // Placeholder visual
                                borderColor: c.green,
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                    });
                },

                // UTILS
                isInvestment(t) {
                    const type = t.type || ''; // Para virtual
                    const cat = (t.category || '').toLowerCase();
                    return type === 'investment' || cat.includes('etf') || cat.includes('inversión') || cat.includes('trade republic');
                },
                formatMoney(n) { return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(n); }
            }
        }
    </script>
</body>
</html>
