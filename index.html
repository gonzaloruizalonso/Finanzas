<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #111827; color: #e2e8f0; font-family: system-ui, sans-serif; }
        .card { background: #1f2937; border: 1px solid #374151; border-radius: 12px; padding: 1.5rem; }
        .input-dark { background: #374151; border: 1px solid #4b5563; color: white; padding: 0.5rem; border-radius: 6px; width: 100%; }
        .btn-primary { background: #2563eb; color: white; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; transition: 0.2s; }
        .btn-primary:hover { background: #1d4ed8; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .tab-inactive { color: #9ca3af; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <div x-data="financeApp()" x-init="init()" class="max-w-2xl mx-auto p-4">
        
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
                Planificador Financiero
            </h1>
            <button @click="init()" class="text-xs text-gray-500 hover:text-white"><i data-lucide="refresh-cw"></i></button>
        </header>

        <div class="flex border-b border-gray-700 mb-6">
            <button @click="tab = 'dashboard'" :class="tab === 'dashboard' ? 'tab-active' : 'tab-inactive'" class="flex-1 pb-3 font-medium text-sm">Dashboard</button>
            <button @click="tab = 'recurring'" :class="tab === 'recurring' ? 'tab-active' : 'tab-inactive'" class="flex-1 pb-3 font-medium text-sm">Fijos & Nómina</button>
            <button @click="tab = 'movements'" :class="tab === 'movements' ? 'tab-active' : 'tab-inactive'" class="flex-1 pb-3 font-medium text-sm">Movimientos</button>
        </div>

        <div x-show="tab === 'dashboard'" class="space-y-6">
            
            <div class="grid grid-cols-2 gap-4">
                <template x-for="acc in accounts" :key="acc.id">
                    <div class="card relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-2 opacity-10">
                            <i data-lucide="wallet" size="48"></i>
                        </div>
                        <div class="text-xs text-gray-400 uppercase tracking-wider mb-1" x-text="acc.name"></div>
                        <div class="text-2xl font-mono font-bold" 
                             :class="acc.name.includes('ING') ? 'text-orange-400' : 'text-blue-400'"
                             x-text="formatMoney(getBalance(acc.id))">
                        </div>
                    </div>
                </template>
            </div>

            <div class="card">
                <h3 class="text-sm text-gray-400 mb-4 flex items-center gap-2"><i data-lucide="pie-chart" size="16"></i> Distribución Mensual Estimada</h3>
                <div class="h-64">
                    <canvas id="budgetChart"></canvas>
                </div>
            </div>

            <div class="card border-l-4 border-purple-500">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <h3 class="font-bold text-lg">Simulador de Inversión</h3>
                        <p class="text-xs text-gray-400">Basado en tu "Cash Flow" (Ingresos fijos - Gastos fijos)</p>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-400">Dinero Libre:</div>
                        <div class="font-mono font-bold text-emerald-400" x-text="formatMoney(stats.freeCashFlow)"></div>
                    </div>
                </div>
                
                <div class="bg-gray-800 p-4 rounded-lg mb-4">
                    <label class="flex justify-between text-sm mb-2">
                        <span>Porcentaje a Invertir</span>
                        <span class="font-bold text-purple-400" x-text="simPercentage + '%'"></span>
                    </label>
                    <input type="range" x-model="simPercentage" min="0" max="80" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                </div>

                <div class="flex justify-between items-center text-sm border-t border-gray-700 pt-4">
                    <span>Mover a Trade Republic:</span>
                    <span class="text-xl font-bold text-white" x-text="formatMoney(stats.freeCashFlow * (simPercentage/100))"></span>
                </div>
            </div>
        </div>

        <div x-show="tab === 'recurring'" class="space-y-6">
            <div class="bg-blue-900/20 border border-blue-900 p-4 rounded-lg text-sm text-blue-200">
                Aquí defines tu estructura base. ¿Cuánto ganas fijo? ¿Qué gastos tienes sí o sí (Netflix, Alquiler)? Esto alimenta la gráfica.
            </div>

            <div class="card space-y-3">
                <h3 class="font-bold mb-2">Añadir Regla Recurrente</h3>
                <div class="grid grid-cols-2 gap-2">
                    <select x-model="newRec.type" class="input-dark">
                        <option value="expense">Gasto Fijo (-)</option>
                        <option value="income">Ingreso Fijo (+)</option>
                    </select>
                    <input type="number" x-model="newRec.day" placeholder="Día del mes (Ej: 1)" class="input-dark">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" x-model="newRec.name" placeholder="Nombre (Nómina, Alquiler...)" class="input-dark">
                    <input type="number" x-model="newRec.amount" placeholder="Cantidad" class="input-dark">
                </div>
                <select x-model="newRec.account_id" class="input-dark">
                    <option value="">Cuenta Asociada...</option>
                    <template x-for="acc in accounts">
                        <option :value="acc.id" x-text="acc.name"></option>
                    </template>
                </select>
                <button @click="addRecurring()" class="btn-primary w-full">Guardar Regla</button>
            </div>

            <div class="space-y-2">
                <template x-for="rec in recurringList" :key="rec.id">
                    <div class="card p-3 flex justify-between items-center hover:bg-gray-800 transition">
                        <div>
                            <div class="font-bold" x-text="rec.name"></div>
                            <div class="text-xs text-gray-500">
                                Día <span x-text="rec.day_of_month"></span> | <span x-text="getAccountName(rec.account_id)"></span>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="font-mono" :class="rec.type === 'income' ? 'text-green-400' : 'text-red-400'" x-text="rec.type === 'income' ? '+'+rec.amount : '-'+rec.amount"></span>
                            <button @click="deleteRecurring(rec.id)" class="text-red-500 hover:text-white"><i data-lucide="trash-2" size="16"></i></button>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <div x-show="tab === 'movements'" class="space-y-6">
            <div class="card space-y-3">
                <h3 class="font-bold mb-2">Añadir Gasto/Ingreso Puntual</h3>
                <div class="grid grid-cols-2 gap-2">
                    <input type="date" x-model="newTx.date" class="input-dark">
                    <select x-model="newTx.account_id" class="input-dark">
                        <template x-for="acc in accounts">
                            <option :value="acc.id" x-text="acc.name"></option>
                        </template>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" x-model="newTx.category" placeholder="Concepto (Cena, Regalo...)" class="input-dark">
                    <input type="number" x-model="newTx.amount" placeholder="Cantidad (- para gasto)" class="input-dark">
                </div>
                <button @click="addTransaction()" class="btn-primary w-full">Registrar Movimiento</button>
            </div>

            <div class="card p-0 overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-900 text-gray-400">
                        <tr>
                            <th class="p-3">Fecha</th>
                            <th class="p-3">Concepto</th>
                            <th class="p-3 text-right">Cantidad</th>
                            <th class="p-3"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="tx in transactions" :key="tx.id">
                            <tr class="border-t border-gray-700 hover:bg-gray-800">
                                <td class="p-3 text-gray-400" x-text="formatDate(tx.date)"></td>
                                <td class="p-3">
                                    <div x-text="tx.category"></div>
                                    <div class="text-xs text-gray-500" x-text="getAccountName(tx.account_id)"></div>
                                </td>
                                <td class="p-3 text-right font-mono" :class="tx.amount > 0 ? 'text-green-400' : 'text-white'" x-text="tx.amount + '€'"></td>
                                <td class="p-3 text-right">
                                    <button @click="deleteTransaction(tx.id)" class="text-red-500 hover:text-white"><i data-lucide="trash-2" size="14"></i></button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // --- TUS CLAVES AQUÍ ---
        const SUPABASE_URL = 'https://pfohhjmeomixhzktwggl.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_t8scoBrGD4XNEozDZD3ZrA_XCl1kRaE';
        // -----------------------

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        let chartInstance = null;

        function financeApp() {
            return {
                tab: 'dashboard',
                accounts: [],
                transactions: [],
                recurringList: [],
                simPercentage: 20,
                
                // Estadísticas calculadas
                stats: { totalIncome: 0, totalFixedExpenses: 0, freeCashFlow: 0 },

                // Formularios
                newRec: { type: 'expense', name: '', amount: '', day: '', account_id: '' },
                newTx: { date: new Date().toISOString().split('T')[0], category: '', amount: '', account_id: '' },

                async init() {
                    // Cargar datos
                    const [accs, txs, recs] = await Promise.all([
                        db.from('accounts').select('*'),
                        db.from('transactions').select('*').order('date', {ascending: false}),
                        db.from('recurring').select('*').order('day_of_month', {ascending: true})
                    ]);

                    this.accounts = accs.data || [];
                    this.transactions = txs.data || [];
                    this.recurringList = recs.data || [];
                    
                    // Si no hay cuenta seleccionada en formulario, seleccionar la primera
                    if(this.accounts.length > 0) {
                        this.newRec.account_id = this.accounts[0].id;
                        this.newTx.account_id = this.accounts[0].id;
                    }

                    this.calculateStats();
                    this.renderChart();
                    
                    // Inicializar iconos
                    setTimeout(() => lucide.createIcons(), 100);
                },

                calculateStats() {
                    // Calcular Flujo Mensual (Basado en reglas recurrentes)
                    this.stats.totalIncome = this.recurringList
                        .filter(r => r.type === 'income')
                        .reduce((sum, r) => sum + Number(r.amount), 0);

                    this.stats.totalFixedExpenses = this.recurringList
                        .filter(r => r.type === 'expense')
                        .reduce((sum, r) => sum + Number(r.amount), 0);

                    this.stats.freeCashFlow = this.stats.totalIncome - this.stats.totalFixedExpenses;
                },

                // GESTIÓN DE RECURRENTES
                async addRecurring() {
                    if(!this.newRec.name || !this.newRec.amount) return alert("Faltan datos");
                    const { error } = await db.from('recurring').insert([this.newRec]);
                    if(!error) {
                        this.newRec.name = ''; this.newRec.amount = ''; 
                        this.init();
                    } else alert(error.message);
                },
                async deleteRecurring(id) {
                    if(confirm("¿Borrar regla?")) {
                        await db.from('recurring').delete().match({id});
                        this.init();
                    }
                },

                // GESTIÓN DE TRANSACCIONES
                async addTransaction() {
                    if(!this.newTx.amount) return alert("Pon una cantidad");
                    const { error } = await db.from('transactions').insert([this.newTx]);
                    if(!error) {
                        this.newTx.amount = ''; this.newTx.category = '';
                        this.init();
                    }
                },
                async deleteTransaction(id) {
                    if(confirm("¿Borrar movimiento?")) {
                        await db.from('transactions').delete().match({id});
                        this.init();
                    }
                },

                // UTILIDADES
                getBalance(accId) {
                    // Suma de transacciones reales guardadas en DB
                    return this.transactions
                        .filter(t => t.account_id === accId)
                        .reduce((sum, t) => sum + Number(t.amount), 0);
                },
                getAccountName(id) {
                    const acc = this.accounts.find(a => a.id === id);
                    return acc ? acc.name : '...';
                },
                formatMoney(amount) {
                    return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(amount);
                },
                formatDate(dateStr) {
                    return new Date(dateStr).toLocaleDateString('es-ES', { day:'2-digit', month:'2-digit' });
                },

                // GRÁFICA (Chart.js)
                renderChart() {
                    const ctx = document.getElementById('budgetChart');
                    if (chartInstance) chartInstance.destroy();

                    const income = this.stats.totalIncome;
                    const expenses = this.stats.totalFixedExpenses;
                    const free = income - expenses;

                    chartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Gastos Fijos', 'Disponible'],
                            datasets: [{
                                data: [expenses, free > 0 ? free : 0],
                                backgroundColor: ['#ef4444', '#10b981'], // Rojo para gastos, Verde para libre
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'right', labels: { color: 'white' } }
                            }
                        }
                    });
                }
            }
        }
    </script>
</body>
</html>
