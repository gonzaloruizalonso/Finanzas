<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gonzalo Finance OS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* ESTÉTICA CYBERPUNK / FINTECH */
        body { background-color: #0b0f19; color: #cbd5e1; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        .glass { 
            background: rgba(30, 41, 59, 0.4); 
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1); 
            border-radius: 16px; 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            border-color: rgba(56, 189, 248, 0.3);
            transition: all 0.3s ease;
        }

        .gradient-text {
            background: linear-gradient(to right, #38bdf8, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Scrollbar invisible */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body class="p-2 md:p-6 pb-24 max-w-7xl mx-auto selection:bg-blue-500 selection:text-white">

    <div x-data="financeOS()" x-init="init()" class="space-y-6">

        <header class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600/20 p-3 rounded-xl border border-blue-500/30">
                    <i data-lucide="activity" class="text-blue-400 w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-white tracking-tight">Gonzalo <span class="gradient-text">Finance OS</span></h1>
                    <p class="text-xs text-gray-500 font-mono" x-text="'Última sincro: ' + new Date().toLocaleTimeString()"></p>
                </div>
            </div>
            
            <button @click="showAddModal = true" class="group bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-blue-900/40 flex items-center gap-2 transition-all hover:scale-105">
                <i data-lucide="plus" class="w-5 h-5 group-hover:rotate-90 transition-transform"></i>
                <span>Añadir Movimiento</span>
            </button>
        </header>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="glass p-5 card-hover">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs text-gray-400 uppercase font-bold tracking-wider">Patrimonio Neto</span>
                    <i data-lucide="wallet" class="w-4 h-4 text-emerald-400"></i>
                </div>
                <div class="text-3xl font-mono font-bold text-white" x-text="formatMoney(kpi.totalBalance)"></div>
                <div class="text-xs text-emerald-400 mt-1 flex items-center gap-1">
                    <i data-lucide="trending-up" class="w-3 h-3"></i> Total Global
                </div>
            </div>

            <div class="glass p-5 card-hover relative overflow-hidden">
                <div class="absolute right-0 top-0 p-4 opacity-5">
                    <i data-lucide="bar-chart-2" class="w-24 h-24"></i>
                </div>
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs text-gray-400 uppercase font-bold tracking-wider">Inversión (ETF)</span>
                    <i data-lucide="pie-chart" class="w-4 h-4 text-purple-400"></i>
                </div>
                <div class="text-3xl font-mono font-bold text-purple-400" x-text="formatMoney(kpi.totalInvested)"></div>
                <div class="text-xs text-gray-500 mt-1">Acumulado en Trade Rep.</div>
            </div>

            <div class="glass p-5 card-hover">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs text-gray-400 uppercase font-bold tracking-wider">Ahorro Este Mes</span>
                    <i data-lucide="piggy-bank" class="w-4 h-4 text-blue-400"></i>
                </div>
                <div class="text-3xl font-mono font-bold" :class="kpi.monthSavings >= 0 ? 'text-blue-400' : 'text-red-400'" x-text="formatMoney(kpi.monthSavings)"></div>
                <div class="text-xs text-gray-500 mt-1">Ingresos - Gastos</div>
            </div>

            <div class="glass p-5 card-hover">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs text-gray-400 uppercase font-bold tracking-wider">Gastos Este Mes</span>
                    <i data-lucide="flame" class="w-4 h-4 text-red-400"></i>
                </div>
                <div class="text-3xl font-mono font-bold text-red-400" x-text="formatMoney(kpi.monthExpenses)"></div>
                <div class="text-xs text-gray-500 mt-1">Salidas de caja</div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-auto">
            
            <div class="glass p-6 md:col-span-2 flex flex-col h-96">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i data-lucide="activity" class="text-blue-400 w-5 h-5"></i> Evolución Financiera
                </h3>
                <div class="flex-1 relative w-full h-full">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <div class="glass p-6 flex flex-col h-96">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i data-lucide="layers" class="text-emerald-400 w-5 h-5"></i> Distribución
                </h3>
                <div class="flex-1 relative flex justify-center">
                    <canvas id="distributionChart"></canvas>
                </div>
                <div class="mt-4 space-y-2">
                    <template x-for="acc in accounts" :key="acc.id">
                        <div class="flex justify-between text-xs">
                            <span x-text="acc.name" class="text-gray-400"></span>
                            <span x-text="formatMoney(acc.current_balance)" class="font-mono text-white"></span>
                        </div>
                    </template>
                </div>
            </div>

            <div class="glass p-6 h-80">
                <h3 class="font-bold text-lg mb-2 flex items-center gap-2">
                    <i data-lucide="radar" class="text-purple-400 w-5 h-5"></i> Radar de Gastos
                </h3>
                <div class="h-full relative pb-6">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>

            <div class="glass p-6 md:col-span-2 h-80">
                <h3 class="font-bold text-lg mb-2 flex items-center gap-2">
                    <i data-lucide="trending-up" class="text-green-400 w-5 h-5"></i> Crecimiento del Patrimonio
                </h3>
                <div class="h-full relative pb-6">
                    <canvas id="wealthChart"></canvas>
                </div>
            </div>
        </div>

        <div class="glass p-6">
            <h3 class="font-bold text-lg mb-4 text-gray-400 uppercase tracking-widest text-xs">Últimos Movimientos</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm whitespace-nowrap">
                    <thead class="text-xs text-gray-500 uppercase bg-gray-800/50 border-b border-gray-700">
                        <tr>
                            <th class="p-4 rounded-tl-lg">Fecha</th>
                            <th class="p-4">Concepto</th>
                            <th class="p-4">Cuenta</th>
                            <th class="p-4 text-right rounded-tr-lg">Importe</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800">
                        <template x-for="tx in transactions.slice(0, 10)" :key="tx.id">
                            <tr class="hover:bg-white/5 transition">
                                <td class="p-4 font-mono text-gray-400" x-text="formatDate(tx.date)"></td>
                                <td class="p-4 font-medium text-white">
                                    <div x-text="tx.category"></div>
                                </td>
                                <td class="p-4">
                                    <span class="px-2 py-1 rounded text-xs bg-gray-800 text-gray-300 border border-gray-700" x-text="getAccountName(tx.account_id)"></span>
                                </td>
                                <td class="p-4 text-right font-mono font-bold" 
                                    :class="tx.amount > 0 ? 'text-emerald-400' : 'text-white'"
                                    x-text="formatMoney(tx.amount)">
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <div x-show="showAddModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4" x-transition style="display: none;">
            <div class="bg-gray-900 border border-gray-700 w-full max-w-lg rounded-2xl p-6 shadow-2xl relative">
                <button @click="showAddModal = false" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i data-lucide="x"></i></button>
                
                <h2 class="text-xl font-bold mb-6 text-white">Registrar Actividad</h2>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-2">
                        <button @click="newTx.type='expense'" :class="newTx.type==='expense' ? 'bg-red-500 text-white ring-2 ring-red-300' : 'bg-gray-800 text-gray-400'" class="p-3 rounded-lg font-bold text-sm transition">Gasto</button>
                        <button @click="newTx.type='income'" :class="newTx.type==='income' ? 'bg-emerald-500 text-white ring-2 ring-emerald-300' : 'bg-gray-800 text-gray-400'" class="p-3 rounded-lg font-bold text-sm transition">Ingreso</button>
                        <button @click="newTx.type='investment'" :class="newTx.type==='investment' ? 'bg-purple-500 text-white ring-2 ring-purple-300' : 'bg-gray-800 text-gray-400'" class="p-3 rounded-lg font-bold text-sm transition">Inversión</button>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs text-gray-500">Fecha</label>
                            <input type="date" x-model="newTx.date" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs text-gray-500">Cantidad</label>
                            <input type="number" x-model="newTx.amount" placeholder="0.00" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none font-mono text-lg">
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs text-gray-500">Cuenta</label>
                        <select x-model="newTx.account_id" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none">
                            <template x-for="acc in accounts" :key="acc.id">
                                <option :value="acc.id" x-text="acc.name"></option>
                            </template>
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs text-gray-500">Concepto</label>
                        <input type="text" x-model="newTx.category" placeholder="Ej: Netflix, Nómina, ETF S&P500..." class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none">
                    </div>

                    <button @click="addTransaction()" class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl font-bold text-white shadow-lg shadow-blue-900/50 hover:shadow-blue-900/80 transition mt-2">
                        Guardar Movimiento
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // ⬇️ PEGA AQUÍ TUS CLAVES DE SUPABASE ⬇️
        const SUPABASE_URL = 'https://pfohhjmeomixhzktwggl.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_t8scoBrGD4XNEozDZD3ZrA_XCl1kRaE';
        // ==========================================

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Colores del sistema
        const colors = {
            green: '#10b981', red: '#ef4444', blue: '#3b82f6', purple: '#a855f7', 
            slate: '#64748b', bg: '#0b0f19'
        };

        function financeOS() {
            return {
                showAddModal: false,
                accounts: [],
                transactions: [],
                kpi: { totalBalance: 0, totalInvested: 0, monthSavings: 0, monthExpenses: 0 },
                newTx: { type: 'expense', amount: '', category: '', date: new Date().toISOString().split('T')[0], account_id: '' },

                async init() {
                    await this.loadData();
                    lucide.createIcons();
                },

                async loadData() {
                    // Carga paralela
                    const [accs, txs] = await Promise.all([
                        db.from('accounts').select('*').order('name'),
                        db.from('transactions').select('*').order('date', {ascending: true}) // Orden cronológico vital para gráficas
                    ]);

                    this.accounts = accs.data || [];
                    this.transactions = txs.data || [];
                    
                    // Cálculo de Saldos Totales
                    let globalBalance = 0;
                    this.accounts = this.accounts.map(acc => {
                        const accTxs = this.transactions.filter(t => t.account_id === acc.id);
                        const sum = accTxs.reduce((a, b) => a + Number(b.amount), 0);
                        const total = (Number(acc.initial_balance) || 0) + sum;
                        globalBalance += total;
                        return { ...acc, current_balance: total };
                    });
                    
                    this.kpi.totalBalance = globalBalance;
                    this.calculateMonthKPIs();
                    this.renderCharts();

                    // Pre-seleccionar cuenta
                    if(this.accounts.length && !this.newTx.account_id) this.newTx.account_id = this.accounts[0].id;
                },

                calculateMonthKPIs() {
                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    
                    let income = 0;
                    let expense = 0;
                    let invested = 0;

                    this.transactions.forEach(t => {
                        const d = new Date(t.date); // Aquí puede ser el error si fecha es invalida, pero supabase suele mandar ISO
                        const amount = Number(t.amount);
                        const isInv = this.isInvestment(t);

                        // Total Invertido (Histórico)
                        if(isInv) this.kpi.totalInvested += Math.abs(amount);

                        // Métricas del Mes Actual
                        if(d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            if(amount > 0) income += amount;
                            else if(!isInv) expense += Math.abs(amount);
                        }
                    });

                    this.kpi.monthExpenses = expense;
                    this.kpi.monthSavings = income - expense;
                },

                renderCharts() {
                    // Destruir anteriores si existen (limpieza)
                    Chart.helpers.each(Chart.instances, (instance) => { instance.destroy(); });

                    // Preparar datos agrupados por mes (YYYY-MM)
                    const months = {};
                    const categories = {};
                    let wealthAccumulated = this.accounts.reduce((sum, a) => sum + (Number(a.initial_balance)||0), 0); // Base inicial aproximada
                    const wealthData = [];

                    this.transactions.forEach(t => {
                        const dateStr = t.date.substring(0, 7); // "2023-11" -> MÁS SEGURO QUE NEW DATE()
                        const amount = Number(t.amount);
                        
                        // Datos para Línea Temporal
                        if(!months[dateStr]) months[dateStr] = { income: 0, expense: 0, invest: 0 };
                        if(amount > 0) months[dateStr].income += amount;
                        else if(this.isInvestment(t)) months[dateStr].invest += Math.abs(amount);
                        else {
                            months[dateStr].expense += Math.abs(amount);
                            // Datos para Radar (Categorías)
                            const cat = t.category || 'Otros';
                            if(!categories[cat]) categories[cat] = 0;
                            categories[cat] += Math.abs(amount);
                        }

                        // Datos para Patrimonio (Acumulativo simplificado)
                        wealthAccumulated += amount;
                        wealthData.push({ x: t.date, y: wealthAccumulated });
                    });

                    const labels = Object.keys(months).sort(); // Ordenar meses cronológicamente
                    // Cortar a los últimos 6 meses para que se vea bien
                    const recentLabels = labels.slice(-6); 

                    // 1. GRÁFICO PRINCIPAL (Barras Agrupadas)
                    new Chart(document.getElementById('mainChart'), {
                        type: 'bar',
                        data: {
                            labels: recentLabels,
                            datasets: [
                                { label: 'Ingresos', data: recentLabels.map(l => months[l].income), backgroundColor: colors.green, borderRadius: 4 },
                                { label: 'Gastos', data: recentLabels.map(l => months[l].expense), backgroundColor: colors.red, borderRadius: 4 },
                                { label: 'Inversión', data: recentLabels.map(l => months[l].invest), backgroundColor: colors.purple, borderRadius: 4 }
                            ]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: { 
                                y: { grid: { color: '#1e293b' }, ticks: { color: colors.slate } },
                                x: { grid: { display: false }, ticks: { color: colors.slate } }
                            },
                            plugins: { legend: { labels: { color: 'white' } } }
                        }
                    });

                    // 2. DISTRIBUCIÓN (Doughnut)
                    new Chart(document.getElementById('distributionChart'), {
                        type: 'doughnut',
                        data: {
                            labels: this.accounts.map(a => a.name),
                            datasets: [{
                                data: this.accounts.map(a => a.current_balance),
                                backgroundColor: [colors.blue, colors.purple, colors.green],
                                borderWidth: 0
                            }]
                        },
                        options: { cutout: '70%', plugins: { legend: { position: 'bottom', labels: { color: 'white' } } } }
                    });

                    // 3. RADAR DE GASTOS
                    const topCats = Object.entries(categories).sort((a,b) => b[1]-a[1]).slice(0, 5); // Top 5
                    new Chart(document.getElementById('radarChart'), {
                        type: 'radar',
                        data: {
                            labels: topCats.map(c => c[0]),
                            datasets: [{
                                label: 'Gastos por Categoría',
                                data: topCats.map(c => c[1]),
                                borderColor: colors.purple,
                                backgroundColor: 'rgba(168, 85, 247, 0.2)',
                                pointBackgroundColor: colors.purple
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: { r: { grid: { color: '#334155' }, ticks: { display: false }, pointLabels: { color: 'white' } } },
                            plugins: { legend: { display: false } }
                        }
                    });

                    // 4. EVOLUCIÓN PATRIMONIO (Line Area)
                    // Simplificamos wealthData para el gráfico (tomamos el saldo al final de cada mes para no saturar)
                    const wealthByMonth = recentLabels.map(m => {
                        // Buscar el último valor acumulado de ese mes
                        // Esto es una aproximación visual
                        let bal = 0;
                        let found = false;
                        // Recalcular saldo hasta ese mes
                        this.transactions.forEach(t => {
                            if(t.date.substring(0,7) <= m) bal += Number(t.amount);
                        });
                        // Sumar saldos iniciales
                        const initials = this.accounts.reduce((s,a) => s + (Number(a.initial_balance)||0),0);
                        return initials + bal;
                    });

                    new Chart(document.getElementById('wealthChart'), {
                        type: 'line',
                        data: {
                            labels: recentLabels,
                            datasets: [{
                                label: 'Patrimonio Total',
                                data: wealthByMonth,
                                borderColor: colors.blue,
                                backgroundColor: (ctx) => {
                                    const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 300);
                                    gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
                                    gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                                    return gradient;
                                },
                                fill: true, tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: { 
                                y: { grid: { color: '#1e293b' }, ticks: { color: colors.slate } },
                                x: { grid: { display: false }, ticks: { color: colors.slate } }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                },

                // UTILS
                async addTransaction() {
                    if(!this.newTx.amount) return;
                    let amount = Math.abs(Number(this.newTx.amount));
                    if(this.newTx.type !== 'income') amount = -amount;
                    
                    // Categoría automática si es inversión
                    let cat = this.newTx.category;
                    if(this.newTx.type === 'investment' && !cat) cat = 'Inversión ETF';

                    const { error } = await db.from('transactions').insert([{
                        account_id: this.newTx.account_id,
                        amount: amount,
                        category: cat,
                        date: this.newTx.date
                    }]);

                    if(!error) {
                        this.showAddModal = false;
                        this.newTx.amount = ''; this.newTx.category = '';
                        this.loadData();
                    }
                },
                isInvestment(t) {
                    const c = (t.category || '').toLowerCase();
                    return c.includes('etf') || c.includes('inversión') || c.includes('trade republic') || c.includes('bolsa');
                },
                getAccountName(id) { const a = this.accounts.find(x => x.id === id); return a ? a.name : '...'; },
                formatMoney(n) { return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(n); },
                formatDate(d) { return new Date(d).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' }); }
            }
        }
    </script>
</body>
</html>
