<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gonzalo Finance Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #0b0f19; color: #cbd5e1; font-family: system-ui, sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 16px; }
        .chart-container { position: relative; height: 400px; width: 100%; }
        input, select { background: #1e293b; border: 1px solid #334155; color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; }
        input:focus, select:focus { border-color: #3b82f6; }
    </style>
</head>
<body class="p-4 md:p-8 pb-32 max-w-7xl mx-auto">

    <div x-data="app()" x-init="init()" class="space-y-8">

        <header class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-white tracking-tight">Simulador Financiero</h1>
                <p class="text-sm text-gray-500">Proyecci칩n Real 2026 (Gastos vs Transferencias)</p>
            </div>
            <button @click="showModal = true" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-blue-900/20 flex items-center gap-2 transition hover:scale-105">
                <i data-lucide="plus" class="w-5 h-5"></i> A침adir Regla
            </button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="glass p-6 border-l-4 border-yellow-500">
                <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">Patrimonio Total (Hoy)</div>
                <div class="text-4xl font-mono font-bold text-white mt-2" x-text="formatMoney(kpi.totalWealth)"></div>
                <div class="text-xs text-yellow-500 mt-2">Suma de todas tus cuentas</div>
            </div>
            
            <div class="glass p-6 border-l-4 border-red-500">
                <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">Gastos Fijos Mensuales</div>
                <div class="text-4xl font-mono font-bold text-red-400 mt-2" x-text="formatMoney(kpi.fixedExpenses)"></div>
                <div class="text-xs text-gray-500 mt-2">Salida real de dinero</div>
            </div>

            <div class="glass p-6 border-l-4 border-blue-500">
                <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">Movimiento Interno (Ahorro)</div>
                <div class="text-4xl font-mono font-bold text-blue-400 mt-2" x-text="formatMoney(kpi.internalTransfers)"></div>
                <div class="text-xs text-gray-500 mt-2">ING -> TR / Reforma (No se pierde)</div>
            </div>
        </div>

        <div class="glass p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg text-white flex items-center gap-2">
                    <i data-lucide="line-chart" class="text-yellow-400 w-5 h-5"></i>
                    Futuro de tu Patrimonio
                </h3>
                <div class="flex gap-4 text-xs">
                    <div class="flex items-center gap-2"><div class="w-3 h-3 bg-red-500 rounded"></div> Gasto (Resta)</div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 bg-blue-500 rounded"></div> Transferencia (Neutro)</div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 bg-yellow-400 rounded-full"></div> Tu Dinero (Total)</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="projectionChart"></canvas>
            </div>
        </div>

        <div class="glass p-6">
            <h3 class="font-bold text-gray-400 uppercase text-xs mb-4">Tus Reglas Activas</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm text-gray-300">
                    <thead class="bg-gray-800/50 text-xs uppercase text-gray-500">
                        <tr>
                            <th class="p-3">Concepto</th>
                            <th class="p-3">Tipo</th>
                            <th class="p-3">Fin</th>
                            <th class="p-3 text-right">Cantidad</th>
                            <th class="p-3 text-center"></th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        <template x-for="rule in recurringRules" :key="rule.id">
                            <tr class="hover:bg-white/5">
                                <td class="p-3 font-bold text-white" x-text="rule.name"></td>
                                <td class="p-3">
                                    <span class="px-2 py-1 rounded text-[10px] uppercase font-bold border"
                                        :class="{
                                            'border-red-500 text-red-400': rule.type === 'expense',
                                            'border-green-500 text-green-400': rule.type === 'income',
                                            'border-blue-500 text-blue-400': rule.type === 'transfer'
                                        }"
                                        x-text="rule.type === 'transfer' ? 'Transferencia Interna' : (rule.type === 'income' ? 'Ingreso' : 'Gasto')">
                                    </span>
                                </td>
                                <td class="p-3 text-xs text-gray-400" x-text="rule.end_date ? new Date(rule.end_date).toLocaleDateString() : 'Indefinido'"></td>
                                <td class="p-3 text-right font-mono" x-text="formatMoney(rule.amount)"></td>
                                <td class="p-3 text-center">
                                    <button @click="deleteRule(rule.id)" class="text-red-500 hover:text-white"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <div x-show="showModal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" x-transition style="display: none;">
            <div class="bg-gray-900 border border-gray-700 w-full max-w-md rounded-2xl p-6 relative shadow-2xl">
                <button @click="showModal = false" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i data-lucide="x"></i></button>
                
                <h2 class="text-xl font-bold text-white mb-6">A침adir Regla Recurrente</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">쯈u칠 es?</label>
                        <select x-model="form.type">
                            <option value="expense">游댮 Gasto (Resta Patrimonio)</option>
                            <option value="transfer">游댯 Transferencia Interna (Neutro - ING a TR)</option>
                            <option value="income">游릭 Ingreso (Suma Patrimonio)</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Concepto</label>
                        <input type="text" x-model="form.name" placeholder="Ej: Netflix, TR, Reforma...">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Cantidad</label>
                            <input type="number" x-model="form.amount" placeholder="0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">D칤a del mes</label>
                            <input type="number" x-model="form.day_of_month" placeholder="1">
                        </div>
                    </div>

                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">쯊iene fecha fin? (Opcional)</label>
                        <input type="date" x-model="form.end_date" class="text-gray-400">
                        <p class="text-[10px] text-gray-600 mt-1">Si lo dejas vac칤o, ser치 para siempre.</p>
                    </div>

                    <div class="pt-2">
                        <label class="text-xs text-gray-500 mb-1 block">Cuenta Origen</label>
                        <select x-model="form.account_id">
                            <template x-for="acc in accounts" :key="acc.id">
                                <option :value="acc.id" x-text="acc.name"></option>
                            </template>
                        </select>
                    </div>

                    <button @click="saveRule()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-xl text-white font-bold shadow-lg mt-2">
                        Guardar Regla
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ==========================
        // TUS CLAVES SUPABASE
        const SUPABASE_URL = 'https://pfohhjmeomixhzktwggl.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_t8scoBrGD4XNEozDZD3ZrA_XCl1kRaE';
        // ==========================

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        function app() {
            return {
                showModal: false,
                accounts: [],
                recurringRules: [],
                transactions: [], // Para calcular saldo inicial real
                kpi: { totalWealth: 0, fixedExpenses: 0, internalTransfers: 0 },
                form: { type: 'expense', name: '', amount: '', day_of_month: '', end_date: '', account_id: '' },

                async init() {
                    await this.loadData();
                    lucide.createIcons();
                },

                async loadData() {
                    // Cargar datos
                    const [accs, recs, txs] = await Promise.all([
                        db.from('accounts').select('*'),
                        db.from('recurring').select('*').order('day_of_month'),
                        db.from('transactions').select('*')
                    ]);

                    this.accounts = accs.data || [];
                    this.recurringRules = recs.data || [];
                    this.transactions = txs.data || [];

                    // 1. CALCULAR PATRIMONIO ACTUAL REAL (Saldo Inicial + Transacciones Pasadas)
                    this.kpi.totalWealth = 0;
                    this.accounts.forEach(acc => {
                        const accTx = this.transactions.filter(t => t.account_id === acc.id);
                        const sumTx = accTx.reduce((sum, t) => sum + Number(t.amount), 0);
                        const realBalance = (Number(acc.initial_balance) || 0) + sumTx;
                        this.kpi.totalWealth += realBalance;
                    });

                    // Init form
                    if(this.accounts.length) this.form.account_id = this.accounts[0].id;

                    this.calculateStructuralKPIs();
                    this.renderChart();
                },

                calculateStructuralKPIs() {
                    this.kpi.fixedExpenses = 0;
                    this.kpi.internalTransfers = 0;

                    // Calculamos bas치ndonos en las reglas activas HOY
                    this.recurringRules.forEach(r => {
                        const amt = Number(r.amount);
                        // Solo sumamos si no ha caducado
                        if (!r.end_date || new Date(r.end_date) > new Date()) {
                            if(r.type === 'expense') this.kpi.fixedExpenses += amt;
                            if(r.type === 'transfer') this.kpi.internalTransfers += amt;
                        }
                    });
                },

                renderChart() {
                    const ctx = document.getElementById('projectionChart');
                    Chart.helpers.each(Chart.instances, i => i.destroy());

                    const labels = [];
                    const dataWealth = [];
                    const dataIncome = [];
                    const dataExpense = [];
                    const dataTransfer = [];

                    let currentWealth = this.kpi.totalWealth;
                    const today = new Date();

                    // PROYECCI칍N A 12 MESES
                    for (let i = 0; i < 12; i++) {
                        const targetDate = new Date(today.getFullYear(), today.getMonth() + i, 1);
                        labels.push(targetDate.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' }));

                        let monthIncome = 0;
                        let monthExpense = 0;
                        let monthTransfer = 0;

                        // Recorrer reglas para este mes espec칤fico
                        this.recurringRules.forEach(r => {
                            // L칍GICA DE FECHA FIN:
                            // Si la regla tiene fecha fin Y la fecha fin es ANTERIOR a este mes de la gr치fica...
                            // ... IGNORAMOS la regla (ya no se paga)
                            if (r.end_date && new Date(r.end_date) < targetDate) {
                                return; 
                            }

                            const amt = Number(r.amount);
                            if (r.type === 'income') monthIncome += amt;
                            if (r.type === 'expense') monthExpense += amt;
                            if (r.type === 'transfer') monthTransfer += amt;
                        });

                        // C츼LCULO DEL PATRIMONIO
                        // Solo Ingresos y Gastos afectan al total.
                        // Transferencias NO, porque el dinero se queda en casa.
                        currentWealth = currentWealth + monthIncome - monthExpense;

                        dataWealth.push(currentWealth);
                        dataIncome.push(monthIncome);
                        dataExpense.push(monthExpense); // Solo lo que pierdes de verdad
                        dataTransfer.push(monthTransfer); // Solo visual
                    }

                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    type: 'line',
                                    label: 'Patrimonio Total',
                                    data: dataWealth,
                                    borderColor: '#facc15', // Amarillo
                                    backgroundColor: 'rgba(250, 204, 21, 0.1)',
                                    borderWidth: 3,
                                    tension: 0.3,
                                    fill: true,
                                    order: 1,
                                    yAxisID: 'yWealth'
                                },
                                {
                                    label: 'Gastos (Salida)',
                                    data: dataExpense,
                                    backgroundColor: '#ef4444', // Rojo
                                    order: 2,
                                    stack: 'flow'
                                },
                                {
                                    label: 'Transferencia Interna (Ahorro)',
                                    data: dataTransfer,
                                    backgroundColor: '#3b82f6', // Azul
                                    order: 3,
                                    stack: 'flow'
                                },
                                {
                                    label: 'Ingresos',
                                    data: dataIncome,
                                    backgroundColor: '#10b981', // Verde
                                    order: 4,
                                    stack: 'flow' // Apilamos todo para ver volumen de movimiento
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            scales: {
                                x: { grid: { display: false }, ticks: { color: '#94a3b8' } },
                                y: { display: false }, // Ocultamos eje izquierdo
                                yWealth: {
                                    position: 'right',
                                    grid: { color: '#334155' },
                                    ticks: { color: '#facc15', callback: v => v/1000 + 'k' }
                                }
                            },
                            plugins: {
                                legend: { labels: { color: 'white' } },
                                tooltip: {
                                    callbacks: {
                                        label: (c) => c.dataset.label + ': ' + new Intl.NumberFormat('es-ES', {style:'currency',currency:'EUR'}).format(c.raw)
                                    }
                                }
                            }
                        }
                    });
                },

                async saveRule() {
                    if(!this.form.name || !this.form.amount) return alert("Faltan datos");

                    const { error } = await db.from('recurring').insert([{
                        name: this.form.name,
                        amount: Number(this.form.amount),
                        type: this.form.type, // Ahora acepta 'transfer'
                        day_of_month: this.form.day_of_month || 1,
                        end_date: this.form.end_date || null,
                        account_id: this.form.account_id
                    }]);

                    if(error) alert(error.message);
                    else {
                        this.showModal = false;
                        this.loadData();
                    }
                },

                async deleteRule(id) {
                    if(confirm("쮹orrar?")) {
                        await db.from('recurring').delete().eq('id', id);
                        this.loadData();
                    }
                },
                
                formatMoney(n) { return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(n); }
            }
        }
    </script>
</body>
</html>
