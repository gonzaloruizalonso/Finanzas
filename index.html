     <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Financiero Gonzalo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; }
        .glass { background: #1e293b; border: 1px solid #334155; border-radius: 12px; }
        .input-dark { background: #0f172a; border: 1px solid #334155; color: white; padding: 0.5rem; border-radius: 6px; width: 100%; }
        .btn { padding: 0.5rem 1rem; border-radius: 6px; font-weight: bold; transition: 0.2s; cursor: pointer; }
        .btn-blue { background: #2563eb; color: white; } .btn-blue:hover { background: #1d4ed8; }
        .btn-green { background: #10b981; color: white; } .btn-green:hover { background: #059669; }
    </style>
</head>
<body class="p-4 max-w-xl mx-auto pb-24">

    <div x-data="app()" x-init="init()">
        
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-xl font-bold text-blue-400">Finanzas Personales</h1>
            <button @click="showConfig = !showConfig" class="text-gray-400 hover:text-white p-2 bg-gray-800 rounded-lg flex items-center gap-2">
                <i data-lucide="settings" class="w-4 h-4"></i> Ajustar Saldos
            </button>
        </div>

        <div x-show="showConfig" class="mb-6 bg-slate-800 p-4 rounded-xl border border-blue-500 shadow-2xl transition" x-transition>
            <h2 class="font-bold mb-4 text-blue-300">Configuración Inicial</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-400">Mi Sueldo Mensual (Neto)</label>
                    <div class="flex gap-2">
                        <input type="number" x-model="config.salary" class="input-dark">
                        <button @click="updateSalary()" class="btn btn-green text-xs">Guardar</button>
                    </div>
                </div>

                <div class="border-t border-gray-700 pt-4">
                    <p class="text-xs text-gray-400 mb-2">Saldos Actuales (Lo que dice tu banco app ahora mismo)</p>
                    <template x-for="acc in accounts" :key="acc.id">
                        <div class="flex justify-between items-center mb-2 gap-2">
                            <span x-text="acc.name" class="text-sm w-1/3"></span>
                            <input type="number" x-model="acc.tempBalance" placeholder="Ej: 5000" class="input-dark text-right">
                            <button @click="updateBalance(acc)" class="p-2 bg-blue-600 rounded hover:bg-blue-500"><i data-lucide="save" class="w-4 h-4"></i></button>
                        </div>
                    </template>
                </div>
            </div>
            <button @click="showConfig = false" class="w-full mt-4 text-xs text-gray-500 hover:text-white">Cerrar</button>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-6">
            <template x-for="acc in accounts" :key="acc.id">
                <div class="glass p-4 relative">
                    <div class="text-xs text-gray-400 uppercase font-bold" x-text="acc.name"></div>
                    <div class="text-2xl font-mono mt-1" 
                         :class="acc.name.includes('ING') ? 'text-orange-400' : 'text-blue-400'"
                         x-text="formatMoney(acc.current_balance)"></div>
                    <div class="text-xs text-gray-600 mt-1">Saldo Real</div>
                </div>
            </template>
        </div>

        <div class="glass p-4 mb-6">
            <h3 class="text-sm text-gray-400 mb-2">Distribución Mensual (Gastos vs Inversión)</h3>
            <canvas id="monthlyChart" height="150"></canvas>
        </div>

        <div class="glass p-4 mb-6">
            <h3 class="font-bold text-sm mb-3 flex items-center gap-2"><i data-lucide="plus-circle" class="w-4 h-4 text-green-400"></i> Nuevo Movimiento</h3>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="date" x-model="newTx.date" class="input-dark">
                <select x-model="newTx.account_id" class="input-dark">
                    <template x-for="acc in accounts" :key="acc.id">
                        <option :value="acc.id" x-text="acc.name"></option>
                    </template>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="text" x-model="newTx.category" placeholder="Concepto" class="input-dark">
                <input type="number" x-model="newTx.amount" placeholder="Cantidad" class="input-dark">
            </div>
            <div class="flex gap-2">
                <button @click="addTransaction('expense')" class="btn bg-red-900/50 text-red-200 w-1/2 hover:bg-red-900 border border-red-800">Gasto (-)</button>
                <button @click="addTransaction('investment')" class="btn bg-blue-900/50 text-blue-200 w-1/2 hover:bg-blue-900 border border-blue-800">Inversión (ETF)</button>
            </div>
        </div>

        <div class="space-y-2">
            <h3 class="text-xs text-gray-500 uppercase">Historial Reciente</h3>
            <template x-for="tx in transactions" :key="tx.id">
                <div class="glass p-3 flex justify-between items-center text-sm">
                    <div>
                        <div class="font-bold" x-text="tx.category"></div>
                        <div class="text-xs text-gray-500" x-text="formatDate(tx.date)"></div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-mono" :class="tx.amount > 0 ? 'text-green-400' : 'text-white'" x-text="formatMoney(tx.amount)"></span>
                        <button @click="deleteTx(tx.id)" class="text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </div>
                </div>
            </template>
        </div>

    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const SUPABASE_URL = 'https://pfohhjmeomixhzktwggl.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_t8scoBrGD4XNEozDZD3ZrA_XCl1kRaE';
        // ---------------------

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        let chart = null;

        function app() {
            return {
                showConfig: false,
                config: { salary: 0, salaryId: null },
                accounts: [],
                transactions: [],
                newTx: { date: new Date().toISOString().split('T')[0], amount: '', category: '', account_id: '' },

                async init() {
                    await this.loadData();
                    lucide.createIcons();
                },

                async loadData() {
                    // 1. Cargar Cuentas
                    const { data: accs } = await db.from('accounts').select('*').order('name');
                    
                    // 2. Cargar Transacciones
                    const { data: txs } = await db.from('transactions').select('*').order('date', {ascending: false});
                    this.transactions = txs || [];

                    // 3. Cargar Sueldo (Recurrente)
                    const { data: recs } = await db.from('recurring').select('*').eq('name', 'Nómina Mensual');
                    if(recs && recs.length > 0) {
                        this.config.salary = recs[0].amount;
                        this.config.salaryId = recs[0].id;
                    }

                    // 4. Calcular Saldos en tiempo real
                    this.accounts = accs.map(a => {
                        const sumTx = this.transactions
                            .filter(t => t.account_id === a.id)
                            .reduce((sum, t) => sum + Number(t.amount), 0);
                        // Saldo = Saldo Inicial (Base de datos) + Suma de movimientos
                        const total = (Number(a.initial_balance) || 0) + sumTx;
                        return { ...a, current_balance: total, tempBalance: total }; // tempBalance es para el input
                    });

                    // Si no hay cuenta seleccionada, coger la primera
                    if (!this.newTx.account_id && this.accounts.length) this.newTx.account_id = this.accounts[0].id;

                    this.renderChart();
                },

                // --- FUNCIONES DE AJUSTE (LO QUE PEDISTE) ---
                
                async updateBalance(account) {
                    // Truco: Actualizamos el 'initial_balance' en la BD para que cuadre con lo que el usuario quiere
                    // Fórmula: NuevoInitial = LoQueUsuarioQuiere - (SumaDeTransaccionesActuales)
                    const sumTx = this.transactions
                            .filter(t => t.account_id === account.id)
                            .reduce((sum, t) => sum + Number(t.amount), 0);
                    
                    const newInitial = Number(account.tempBalance) - sumTx;

                    const { error } = await db.from('accounts').update({ initial_balance: newInitial }).eq('id', account.id);
                    if (!error) {
                        alert("Saldo actualizado a " + account.tempBalance + "€");
                        this.loadData();
                    }
                },

                async updateSalary() {
                    const payload = {
                        name: 'Nómina Mensual',
                        amount: this.config.salary,
                        day_of_month: 1, // Corregido el nombre de columna
                        type: 'income',
                        account_id: this.accounts.find(a => a.name.includes('ING'))?.id || this.accounts[0].id
                    };

                    let error;
                    if (this.config.salaryId) {
                        ({ error } = await db.from('recurring').update(payload).eq('id', this.config.salaryId));
                    } else {
                        ({ error } = await db.from('recurring').insert([payload]));
                    }
                    if (!error) alert("Sueldo guardado");
                    this.loadData();
                },

                // --- OPERATIVA DIARIA ---

                async addTransaction(type) {
                    if (!this.newTx.amount) return;
                    let amount = Number(this.newTx.amount);
                    if (type === 'expense') amount = -Math.abs(amount);
                    if (type === 'investment') amount = -Math.abs(amount); // Inversión sale de la cuenta como gasto contable, pero lo marcamos con categoría especial

                    const category = type === 'investment' ? 'Inversión ETF' : (this.newTx.category || 'Gasto');

                    const { error } = await db.from('transactions').insert([{
                        account_id: this.newTx.account_id,
                        amount: amount,
                        category: category,
                        date: this.newTx.date
                    }]);

                    if (!error) {
                        this.newTx.amount = ''; this.newTx.category = '';
                        this.loadData();
                    }
                },

                async deleteTx(id) {
                    if(confirm("¿Borrar?")) {
                        await db.from('transactions').delete().eq('id', id);
                        this.loadData();
                    }
                },

                // --- GRÁFICAS Y FORMATOS ---

                formatMoney(num) { return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(num); },
                formatDate(d) { return new Date(d).toLocaleDateString(); },

                renderChart() {
                    const ctx = document.getElementById('monthlyChart');
                    if (chart) chart.destroy();

                    // Agrupar gastos e inversiones del mes actual
                    const currentMonth = new Date().getMonth();
                    let gastos = 0;
                    let inversion = 0;

                    this.transactions.forEach(t => {
                        const tDate = new Date(t.date);
                        if (tDate.getMonth() === currentMonth && t.amount < 0) {
                            if (t.category.toLowerCase().includes('etf') || t.category.toLowerCase().includes('inversión')) {
                                inversion += Math.abs(t.amount);
                            } else {
                                gastos += Math.abs(t.amount);
                            }
                        }
                    });

                    chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Este Mes'],
                            datasets: [
                                { label: 'Gastos', data: [gastos], backgroundColor: '#ef4444' },
                                { label: 'Inversión (ETF)', data: [inversion], backgroundColor: '#3b82f6' }
                            ]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            scales: { x: { stacked: true }, y: { stacked: true } }
                        }
                    });
                }
            }
        }
    </script>
</body>
</html>
