<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Intelligence</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #0f172a; color: #cbd5e1; font-family: system-ui, -apple-system, sans-serif; }
        .glass { background: #1e293b; border: 1px solid #334155; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); border-radius: 12px; }
        .stat-card { background: linear-gradient(145deg, #1e293b, #0f172a); border: 1px solid #334155; }
        
        /* Personalización del Tooltip del Gráfico */
        #chartjs-tooltip { opacity: 1; position: absolute; background: rgba(0, 0, 0, 0.8); color: white; border-radius: 4px; pointer-events: none; transition: all .1s ease; transform: translate(-50%, 0); padding: 10px; z-index: 100; border: 1px solid #475569; }
    </style>
</head>
<body class="p-2 md:p-6 pb-20 max-w-5xl mx-auto">

    <div x-data="dashboard()" x-init="init()" class="space-y-6">

        <header class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
            <div>
                <h1 class="text-2xl font-bold text-white tracking-tight">Panel de Control</h1>
                <p class="text-xs text-gray-500">Visión Estratégica</p>
            </div>
            
            <div class="flex bg-gray-800 p-1 rounded-lg border border-gray-700">
                <button @click="filterAccount = 'all'; renderMainChart()" 
                        :class="filterAccount === 'all' ? 'bg-gray-600 text-white' : 'text-gray-400 hover:text-white'" 
                        class="px-3 py-1 rounded text-xs font-medium transition">Global</button>
                <template x-for="acc in accounts" :key="acc.id">
                    <button @click="filterAccount = acc.id; renderMainChart()" 
                            :class="filterAccount === acc.id ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white'" 
                            class="px-3 py-1 rounded text-xs font-medium transition" x-text="acc.name"></button>
                </template>
            </div>
        </header>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="stat-card p-4 rounded-xl">
                <div class="text-xs text-gray-500 uppercase">Patrimonio Neto</div>
                <div class="text-2xl font-mono font-bold text-white" x-text="formatMoney(kpi.totalBalance)"></div>
            </div>
            <div class="stat-card p-4 rounded-xl">
                <div class="text-xs text-gray-500 uppercase">Inversión Total</div>
                <div class="text-2xl font-mono font-bold text-blue-400" x-text="formatMoney(kpi.totalInvested)"></div>
            </div>
            <div class="stat-card p-4 rounded-xl border-l-2 border-emerald-500">
                <div class="text-xs text-gray-500 uppercase">Ingresos (Año)</div>
                <div class="text-xl font-mono text-emerald-400" x-text="formatMoney(kpi.yearIncome)"></div>
            </div>
            <div class="stat-card p-4 rounded-xl border-l-2 border-red-500">
                <div class="text-xs text-gray-500 uppercase">Gastos (Año)</div>
                <div class="text-xl font-mono text-red-400" x-text="formatMoney(kpi.yearExpense)"></div>
            </div>
        </div>

        <div class="glass p-4 md:p-6 relative">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-white">Flujo de Caja & Inversión</h3>
                <span class="text-xs text-blue-300 bg-blue-900/30 px-2 py-1 rounded border border-blue-800">
                    <i data-lucide="mouse-pointer-click" class="inline w-3 h-3 mr-1"></i> Haz clic en una barra
                </span>
            </div>
            <div class="h-72 w-full">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div x-show="selectedMonthData" x-transition.opacity.duration.500ms class="space-y-4">
            <div class="flex items-center gap-2">
                <div class="h-px bg-gray-700 flex-1"></div>
                <span class="text-sm font-bold text-blue-400 uppercase tracking-widest" x-text="selectedMonthLabel"></span>
                <div class="h-px bg-gray-700 flex-1"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass p-5">
                    <h4 class="text-xs font-bold text-gray-400 mb-4 uppercase">Desglose de Gastos</h4>
                    <div class="h-48 relative">
                        <canvas id="monthDonut"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <span class="text-xs text-gray-500 font-mono">Gastos</span>
                        </div>
                    </div>
                </div>

                <div class="glass p-0 overflow-hidden col-span-1 md:col-span-2">
                    <div class="bg-gray-800/50 p-3 border-b border-gray-700 flex justify-between items-center">
                        <h4 class="text-xs font-bold text-gray-400 uppercase">Movimientos del Mes</h4>
                        <span class="text-xs text-gray-500" x-text="selectedMonthData?.transactions.length + ' movimientos'"></span>
                    </div>
                    <div class="max-h-56 overflow-y-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-500 bg-gray-800 sticky top-0">
                                <tr>
                                    <th class="p-3">Día</th>
                                    <th class="p-3">Concepto</th>
                                    <th class="p-3">Cuenta</th>
                                    <th class="p-3 text-right">Importe</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                                <template x-for="tx in selectedMonthData?.transactions" :key="tx.id">
                                    <tr class="hover:bg-gray-800/50 transition">
                                        <td class="p-3 font-mono text-gray-400" x-text="new Date(tx.date).getDate()"></td>
                                        <td class="p-3 font-medium text-white">
                                            <div x-text="tx.category"></div>
                                        </td>
                                        <td class="p-3 text-xs text-gray-500" x-text="getAccountName(tx.account_id)"></td>
                                        <td class="p-3 text-right font-mono font-bold" 
                                            :class="{
                                                'text-emerald-400': tx.amount > 0,
                                                'text-red-400': tx.amount < 0 && !isInvestment(tx),
                                                'text-blue-400': isInvestment(tx)
                                            }"
                                            x-text="formatMoney(tx.amount)">
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="fixed bottom-6 right-6">
            <button @click="showAddModal = true" class="bg-blue-600 hover:bg-blue-500 text-white rounded-full p-4 shadow-lg shadow-blue-900/50 transition hover:scale-110">
                <i data-lucide="plus" class="w-6 h-6"></i>
            </button>
        </div>

        <div x-show="showAddModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" x-transition style="display: none;">
            <div class="bg-gray-900 border border-gray-700 w-full max-w-md rounded-2xl p-6 shadow-2xl">
                <h2 class="text-xl font-bold mb-4">Nuevo Movimiento</h2>
                <div class="space-y-4">
                    <div class="flex gap-2 bg-gray-800 p-1 rounded-lg">
                        <button @click="newTx.type = 'expense'" :class="newTx.type === 'expense' ? 'bg-red-600 text-white shadow' : 'text-gray-400'" class="flex-1 py-2 rounded-md text-sm font-bold transition">Gasto</button>
                        <button @click="newTx.type = 'income'" :class="newTx.type === 'income' ? 'bg-emerald-600 text-white shadow' : 'text-gray-400'" class="flex-1 py-2 rounded-md text-sm font-bold transition">Ingreso</button>
                        <button @click="newTx.type = 'investment'" :class="newTx.type === 'investment' ? 'bg-blue-600 text-white shadow' : 'text-gray-400'" class="flex-1 py-2 rounded-md text-sm font-bold transition">Inversión</button>
                    </div>
                    
                    <input type="number" x-model="newTx.amount" placeholder="Cantidad (Ej: 50)" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none">
                    <input type="text" x-model="newTx.category" placeholder="Concepto (Ej: Supermercado)" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-blue-500 outline-none">
                    <input type="date" x-model="newTx.date" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white">
                    
                    <select x-model="newTx.account_id" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white">
                        <template x-for="acc in accounts" :key="acc.id">
                            <option :value="acc.id" x-text="acc.name"></option>
                        </template>
                    </select>

                    <div class="flex gap-3 pt-2">
                        <button @click="showAddModal = false" class="flex-1 py-3 text-gray-400 hover:text-white transition">Cancelar</button>
                        <button @click="addTransaction()" class="flex-1 py-3 bg-white text-black font-bold rounded-lg hover:bg-gray-200 transition">Guardar</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // ⬇️ TUS CLAVES AQUÍ ⬇️
        const SUPABASE_URL = 'https://pfohhjmeomixhzktwggl.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_t8scoBrGD4XNEozDZD3ZrA_XCl1kRaE';
        // ==========================================

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        let mainChartInstance = null;
        let monthDonutInstance = null;

        function dashboard() {
            return {
                accounts: [],
                transactions: [],
                filterAccount: 'all', // 'all' o ID de cuenta
                showAddModal: false,
                
                // Estado del Drill-Down (Click en gráfica)
                selectedMonthLabel: '',
                selectedMonthData: null,

                // KPI
                kpi: { totalBalance: 0, totalInvested: 0, yearIncome: 0, yearExpense: 0 },
                
                // Formulario
                newTx: { type: 'expense', amount: '', category: '', date: new Date().toISOString().split('T')[0], account_id: '' },

                async init() {
                    await this.loadData();
                    lucide.createIcons();
                },

                async loadData() {
                    // Cargar datos brutos
                    const [accs, txs] = await Promise.all([
                        db.from('accounts').select('*'),
                        db.from('transactions').select('*').order('date', {ascending: true}) // Orden cronológico para gráficas
                    ]);

                    this.accounts = accs.data || [];
                    const allTransactions = txs.data || [];
                    
                    // Si hay filtro, filtramos transacciones visualmente, pero mantenemos saldo total real
                    this.transactions = allTransactions; // Guardamos todas para cálculos globales

                    // Calcular KPIs Globales
                    this.calculateKPIs(allTransactions);
                    
                    // Renderizar Gráfica Principal
                    this.renderMainChart();
                    
                    // Set default account for form
                    if(this.accounts.length) this.newTx.account_id = this.accounts[0].id;
                },

                calculateKPIs(txs) {
                    // 1. Saldos
                    let balance = 0;
                    this.accounts.forEach(acc => {
                        const accTxs = txs.filter(t => t.account_id === acc.id);
                        const sum = accTxs.reduce((a, b) => a + Number(b.amount), 0);
                        balance += (Number(acc.initial_balance) || 0) + sum;
                    });
                    this.kpi.totalBalance = balance;

                    // 2. Inversiones y Flujos Anuales
                    const currentYear = new Date().getFullYear();
                    this.kpi.totalInvested = 0;
                    this.kpi.yearIncome = 0;
                    this.kpi.yearExpense = 0;

                    txs.forEach(t => {
                        const amount = Number(t.amount);
                        const isInv = this.isInvestment(t);
                        const year = new Date(t.date).getFullYear();

                        if (isInv) this.kpi.totalInvested += Math.abs(amount);
                        
                        if (year === currentYear) {
                            if (amount > 0) this.kpi.yearIncome += amount;
                            else if (!isInv) this.kpi.yearExpense += Math.abs(amount);
                        }
                    });
                },

                // Lógica de Agrupación por Mes para la Gráfica
                processMonthlyData() {
                    const groups = {};
                    
                    // Filtrar por cuenta si es necesario
                    const filteredTxs = this.filterAccount === 'all' 
                        ? this.transactions 
                        : this.transactions.filter(t => t.account_id === this.filterAccount);

                    filteredTxs.forEach(t => {
                        const date = new Date(t.date);
                        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`; // YYYY-MM
                        
                        if (!groups[key]) groups[key] = { income: 0, expense: 0, investment: 0, breakdown: {}, transactions: [] };
                        
                        groups[key].transactions.push(t); // Guardamos la tx para el detalle

                        const amount = Number(t.amount);
                        if (amount > 0) {
                            groups[key].income += amount;
                        } else {
                            if (this.isInvestment(t)) {
                                groups[key].investment += Math.abs(amount);
                            } else {
                                groups[key].expense += Math.abs(amount);
                                // Desglose para el tooltip
                                if (!groups[key].breakdown[t.category]) groups[key].breakdown[t.category] = 0;
                                groups[key].breakdown[t.category] += Math.abs(amount);
                            }
                        }
                    });

                    // Ordenar claves (meses)
                    return Object.keys(groups).sort().map(key => ({
                        month: key,
                        label: new Date(key + '-01').toLocaleDateString('es-ES', { month: 'short', year: '2-digit' }),
                        ...groups[key]
                    }));
                },

                renderMainChart() {
                    const ctx = document.getElementById('mainChart').getContext('2d');
                    if (mainChartInstance) mainChartInstance.destroy();

                    const data = this.processMonthlyData();
                    // Limitar a los últimos 12 meses para que no se vea minúsculo
                    const last12 = data.slice(-12);

                    mainChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: last12.map(d => d.label),
                            datasets: [
                                {
                                    label: 'Ingresos',
                                    data: last12.map(d => d.income),
                                    backgroundColor: '#10b981', // Verde
                                    borderRadius: 4,
                                    stack: 'Stack 0',
                                },
                                {
                                    label: 'Inversión',
                                    data: last12.map(d => d.investment),
                                    backgroundColor: '#3b82f6', // Azul
                                    borderRadius: 4,
                                    stack: 'Stack 1',
                                },
                                {
                                    label: 'Gastos',
                                    data: last12.map(d => d.expense),
                                    backgroundColor: '#ef4444', // Rojo
                                    borderRadius: 4,
                                    stack: 'Stack 1', // Apilado con inversión para ver "salidas totales"
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false }, // Crucial para hover
                            onClick: (e, elements) => {
                                if (elements.length > 0) {
                                    const index = elements[0].index;
                                    this.openMonthDetail(last12[index]);
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        // AQUÍ ESTÁ LA MAGIA DEL HOVER DESGLOSADO
                                        afterBody: (context) => {
                                            const index = context[0].dataIndex;
                                            const monthData = last12[index];
                                            
                                            // Solo mostramos desglose si estamos sobre la barra de gastos
                                            // Buscamos si el tooltip incluye el dataset de gastos (index 2)
                                            const hasExpense = context.find(c => c.datasetIndex === 2);
                                            
                                            if (hasExpense && monthData.expense > 0) {
                                                const breakdown = monthData.breakdown;
                                                // Ordenar por cantidad
                                                const sorted = Object.entries(breakdown).sort((a,b) => b[1] - a[1]);
                                                
                                                let lines = ['--- TOP GASTOS ---'];
                                                sorted.slice(0, 5).forEach(([cat, val]) => { // Top 5
                                                    const pct = Math.round((val / monthData.expense) * 100);
                                                    lines.push(`${cat}: ${pct}% (${Math.round(val)}€)`);
                                                });
                                                return lines;
                                            }
                                        }
                                    },
                                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                    borderColor: '#334155',
                                    borderWidth: 1
                                },
                                legend: { labels: { color: '#94a3b8' } }
                            },
                            scales: {
                                x: { ticks: { color: '#94a3b8' }, grid: { display: false } },
                                y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
                            }
                        }
                    });
                },

                openMonthDetail(monthObj) {
                    this.selectedMonthLabel = monthObj.label;
                    // Ordenar transacciones del mes por fecha descendente
                    monthObj.transactions.sort((a,b) => new Date(b.date) - new Date(a.date));
                    this.selectedMonthData = monthObj;

                    // Renderizar Donut
                    setTimeout(() => {
                        const ctx = document.getElementById('monthDonut');
                        if (monthDonutInstance) monthDonutInstance.destroy();
                        
                        const bd = monthObj.breakdown;
                        const labels = Object.keys(bd);
                        const data = Object.values(bd);

                        monthDonutInstance = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: data,
                                    backgroundColor: ['#f87171', '#fb923c', '#facc15', '#a3e635', '#22d3ee', '#818cf8', '#e879f9'],
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } }
                            }
                        });
                    }, 50);
                    
                    // Scroll suave hacia el detalle
                    setTimeout(() => {
                        document.getElementById('monthDonut').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                },

                // --- UTILIDADES ---

                async addTransaction() {
                    if (!this.newTx.amount || !this.newTx.account_id) return alert("Faltan datos");
                    
                    let finalAmount = Math.abs(Number(this.newTx.amount));
                    if (this.newTx.type !== 'income') finalAmount = -finalAmount;

                    let category = this.newTx.category;
                    if (this.newTx.type === 'investment' && !category) category = 'Inversión ETF';

                    const { error } = await db.from('transactions').insert([{
                        account_id: this.newTx.account_id,
                        amount: finalAmount,
                        category: category,
                        date: this.newTx.date
                    }]);

                    if (!error) {
                        this.showAddModal = false;
                        this.newTx.amount = ''; this.newTx.category = '';
                        await this.loadData(); // Recargar todo
                    } else {
                        alert(error.message);
                    }
                },

                isInvestment(tx) {
                    const cat = (tx.category || '').toLowerCase();
                    return cat.includes('etf') || cat.includes('inversión') || cat.includes('trade republic') || cat.includes('bolsa');
                },
                getAccountName(id) {
                    const acc = this.accounts.find(a => a.id === id);
                    return acc ? acc.name : '...';
                },
                formatMoney(num) { 
                    return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(num); 
                }
            }
        }
    </script>
</body>
</html>
