<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gonzalo: Doble AcumulaciÃ³n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #0b0f19; color: #cbd5e1; font-family: system-ui, sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 16px; }
        .chart-container { position: relative; height: 450px; width: 100%; }
        input, select { background: #1e293b; border: 1px solid #334155; color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; }
        input:focus, select:focus { border-color: #3b82f6; }
    </style>
</head>
<body class="p-4 md:p-8 pb-32 max-w-7xl mx-auto selection:bg-blue-500 selection:text-white">

    <div x-data="app()" x-init="init()" class="space-y-8">

        <header class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white tracking-tight">Gonzalo Finance</h1>
                <p class="text-sm text-gray-500">VisualizaciÃ³n de Doble Motor (Ahorro + InversiÃ³n)</p>
            </div>
            <button @click="showModal = true" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 transition hover:scale-105">
                <i data-lucide="plus" class="w-5 h-5"></i> Nuevo Movimiento
            </button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="glass p-6 border-l-4 border-yellow-500">
                <div class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Patrimonio Total</div>
                <div class="text-3xl font-mono font-bold text-white mt-1" x-text="formatMoney(kpi.totalWealth)"></div>
                <div class="text-xs text-yellow-500 mt-1">Suma Global</div>
            </div>

            <div class="glass p-6 border-l-4 border-blue-500 bg-blue-900/10">
                <div class="text-[10px] text-blue-300 uppercase font-bold tracking-wider">Hucha Ahorro (Base 2k)</div>
                <div class="text-3xl font-mono font-bold text-blue-400 mt-1" x-text="formatMoney(kpi.savingsAccumulated)"></div>
                <div class="text-xs text-blue-300 mt-1">Base 2.000â‚¬ + 125â‚¬/mes</div>
            </div>

            <div class="glass p-6 border-l-4 border-purple-500 bg-purple-900/10">
                <div class="text-[10px] text-purple-300 uppercase font-bold tracking-wider">Cartera InversiÃ³n</div>
                <div class="text-3xl font-mono font-bold text-purple-400 mt-1" x-text="formatMoney(kpi.investedAccumulated)"></div>
                <div class="text-xs text-purple-300 mt-1">Base 0â‚¬ + 50â‚¬/mes</div>
            </div>

            <div class="glass p-6 border-l-4 border-red-500">
                <div class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Gastos Fijos</div>
                <div class="text-2xl font-mono font-bold text-red-400 mt-1" x-text="formatMoney(kpi.fixedExpenses)"></div>
            </div>
        </div>

        <div class="glass p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg text-white flex items-center gap-2">
                    <i data-lucide="trending-up" class="text-blue-400 w-5 h-5"></i>
                    Tus Motores de Crecimiento
                </h3>
                <div class="text-xs text-gray-400 text-right space-y-1">
                    <span class="block text-yellow-500">ðŸŸ¡ Patrimonio Total</span>
                    <span class="block text-blue-400">ðŸ”µ Ahorro (2.000 -> Crece)</span>
                    <span class="block text-purple-400">ðŸŸ£ InversiÃ³n (0 -> Crece)</span>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="projectionChart"></canvas>
            </div>
        </div>

        <div class="glass p-6">
            <h3 class="font-bold text-gray-400 uppercase text-xs mb-4">Reglas Activas</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm text-gray-300">
                    <thead class="bg-gray-800/50 text-xs uppercase text-gray-500">
                        <tr>
                            <th class="p-3">Nombre</th>
                            <th class="p-3">Tipo</th>
                            <th class="p-3 text-right">Importe</th>
                            <th class="p-3 text-center"></th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        <template x-for="rule in recurringRules" :key="rule.id">
                            <tr class="hover:bg-white/5 transition">
                                <td class="p-3 font-bold text-white" x-text="rule.name"></td>
                                <td class="p-3">
                                    <span class="px-2 py-1 rounded text-[10px] uppercase font-bold border"
                                        :class="{
                                            'border-red-500 text-red-400': rule.type === 'expense',
                                            'border-green-500 text-green-400': rule.type === 'income',
                                            'border-blue-500 text-blue-400 bg-blue-900/20': rule.type === 'transfer',
                                            'border-purple-500 text-purple-400 bg-purple-900/20': rule.type === 'investment'
                                        }"
                                        x-text="translateType(rule.type)">
                                    </span>
                                </td>
                                <td class="p-3 text-right font-mono" x-text="formatMoney(rule.amount)"></td>
                                <td class="p-3 text-center">
                                    <button @click="deleteRule(rule.id)" class="text-red-500 hover:text-white"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <div x-show="showModal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" x-transition style="display: none;">
            <div class="bg-gray-900 border border-gray-700 w-full max-w-md rounded-2xl p-6 relative shadow-2xl">
                <button @click="showModal = false" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i data-lucide="x"></i></button>
                <h2 class="text-xl font-bold text-white mb-6">AÃ±adir Regla</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-400 font-bold mb-1 block uppercase">Tipo</label>
                        <select x-model="form.type" class="font-bold">
                            <option value="expense">ðŸ”´ Gasto</option>
                            <option value="transfer">ðŸ”µ Ahorro (Suma a la lÃ­nea Azul)</option>
                            <option value="investment">ðŸŸ£ InversiÃ³n (Suma a la lÃ­nea Morada)</option>
                            <option value="income">ðŸŸ¢ Ingreso</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Concepto</label>
                        <input type="text" x-model="form.name" placeholder="Ej: ETF, Ahorro...">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Cantidad</label>
                            <input type="number" x-model="form.amount" placeholder="0.00" class="font-mono text-lg">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">DÃ­a</label>
                            <input type="number" x-model="form.day_of_month" placeholder="1">
                        </div>
                    </div>
                    <div class="pt-2">
                        <label class="text-xs text-gray-500 mb-1 block">Cuenta Origen</label>
                        <select x-model="form.account_id">
                            <template x-for="acc in accounts" :key="acc.id">
                                <option :value="acc.id" x-text="acc.name"></option>
                            </template>
                        </select>
                    </div>
                    <button @click="saveRule()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-xl text-white font-bold shadow-lg mt-2">Guardar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ==========================
        // TUS CLAVES AQUI
        const SUPABASE_URL = 'https://pfohhjmeomixhzktwggl.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_t8scoBrGD4XNEozDZD3ZrA_XCl1kRaE';
        // ==========================

        const INITIAL_SAVINGS_BASE = 2000; // <--- AQUÃ ESTÃN TUS 2000â‚¬ DE BASE

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        function app() {
            return {
                showModal: false,
                accounts: [],
                recurringRules: [],
                transactions: [], 
                kpi: { totalWealth: 0, fixedExpenses: 0, investedAccumulated: 0, savingsAccumulated: 0 },
                form: { type: 'expense', name: '', amount: '', day_of_month: '', account_id: '' },

                async init() {
                    await this.loadData();
                    lucide.createIcons();
                },

                async loadData() {
                    const [accs, recs, txs] = await Promise.all([
                        db.from('accounts').select('*'),
                        db.from('recurring').select('*').order('day_of_month'),
                        db.from('transactions').select('*')
                    ]);

                    this.accounts = accs.data || [];
                    this.recurringRules = recs.data || [];
                    this.transactions = txs.data || [];

                    // 1. PATRIMONIO TOTAL
                    this.kpi.totalWealth = 0;
                    this.accounts.forEach(acc => {
                        const accTx = this.transactions.filter(t => t.account_id === acc.id);
                        const sumTx = accTx.reduce((sum, t) => sum + Number(t.amount), 0);
                        this.kpi.totalWealth += (Number(acc.initial_balance) || 0) + sumTx;
                    });
                    
                    // 2. ACUMULADOS ACTUALES (Para los KPIs)
                    // InversiÃ³n empieza en 0
                    this.kpi.investedAccumulated = 0; 
                    // Ahorro empieza en 2000
                    this.kpi.savingsAccumulated = INITIAL_SAVINGS_BASE;

                    if(this.accounts.length) this.form.account_id = this.accounts[0].id;

                    this.calculateStructuralKPIs();
                    this.renderChart();
                },

                calculateStructuralKPIs() {
                    this.kpi.fixedExpenses = 0;
                    this.recurringRules.forEach(r => {
                        if (!r.end_date || new Date(r.end_date) > new Date()) {
                            if(r.type === 'expense') this.kpi.fixedExpenses += Number(r.amount);
                        }
                    });
                },

                renderChart() {
                    const ctx = document.getElementById('projectionChart');
                    Chart.helpers.each(Chart.instances, i => i.destroy());

                    const labels = [];
                    const dataWealth = [];
                    const dataInvestAccumulated = []; 
                    const dataSavingsAccumulated = []; // NUEVA DATA
                    
                    const dataIncome = [];
                    const dataExpense = [];
                    const dataTransfer = [];
                    const dataInvestMonthly = [];

                    let currentWealth = this.kpi.totalWealth;
                    let currentInvested = 0; // Empieza en 0
                    let currentSavings = INITIAL_SAVINGS_BASE; // Empieza en 2000

                    const today = new Date();

                    for (let i = 0; i < 12; i++) {
                        const targetDate = new Date(today.getFullYear(), today.getMonth() + i, 1);
                        labels.push(targetDate.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' }));

                        let mIncome = 0, mExpense = 0, mTransfer = 0, mInvest = 0;

                        this.recurringRules.forEach(r => {
                            if (r.end_date && new Date(r.end_date) < targetDate) return; 

                            const amt = Number(r.amount);
                            if (r.type === 'income') mIncome += amt;
                            if (r.type === 'expense') mExpense += amt;
                            
                            // AHORA DIFERENCIAMOS:
                            if (r.type === 'transfer') { // Ahorro
                                mTransfer += amt;
                            }
                            if (r.type === 'investment') { // InversiÃ³n
                                mInvest += amt;
                            }
                        });

                        // CÃLCULOS
                        currentWealth = currentWealth + mIncome - mExpense;
                        
                        currentInvested = currentInvested + mInvest; // +50
                        currentSavings = currentSavings + mTransfer; // +125 (sobre la base de 2000)

                        dataWealth.push(currentWealth);
                        dataInvestAccumulated.push(currentInvested);
                        dataSavingsAccumulated.push(currentSavings);
                        
                        dataIncome.push(mIncome);
                        dataExpense.push(mExpense);
                        dataTransfer.push(mTransfer);
                        dataInvestMonthly.push(mInvest);
                    }

                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    type: 'line',
                                    label: 'Patrimonio Total',
                                    data: dataWealth,
                                    borderColor: '#facc15', 
                                    backgroundColor: 'rgba(250, 204, 21, 0.05)',
                                    borderWidth: 2,
                                    tension: 0.4,
                                    fill: true,
                                    order: 1,
                                    yAxisID: 'yWealth'
                                },
                                {
                                    type: 'line',
                                    label: 'Hucha Ahorro (Base 2k)', // LÃNEA AZUL
                                    data: dataSavingsAccumulated,
                                    borderColor: '#3b82f6', 
                                    borderWidth: 3,
                                    borderDash: [2, 2], // Punteado fino
                                    pointBackgroundColor: '#3b82f6',
                                    tension: 0.2,
                                    fill: false,
                                    order: 0, 
                                    yAxisID: 'yWealth'
                                },
                                {
                                    type: 'line',
                                    label: 'Cartera InversiÃ³n', // LÃNEA MORADA
                                    data: dataInvestAccumulated,
                                    borderColor: '#a855f7', 
                                    borderWidth: 3,
                                    borderDash: [5, 5], // Punteado largo
                                    pointBackgroundColor: '#a855f7',
                                    tension: 0.2,
                                    fill: false,
                                    order: 0, 
                                    yAxisID: 'yWealth'
                                },
                                {
                                    label: 'Gastos',
                                    data: dataExpense,
                                    backgroundColor: '#ef4444',
                                    order: 3, stack: 'flow'
                                },
                                {
                                    label: 'Aport. InversiÃ³n (50â‚¬)',
                                    data: dataInvestMonthly,
                                    backgroundColor: '#a855f7',
                                    order: 4, stack: 'flow'
                                },
                                {
                                    label: 'Aport. Ahorro (125â‚¬)',
                                    data: dataTransfer,
                                    backgroundColor: '#3b82f6',
                                    order: 5, stack: 'flow'
                                },
                                {
                                    label: 'Ingresos',
                                    data: dataIncome,
                                    backgroundColor: '#10b981',
                                    order: 6, stack: 'flow'
                                }
                            ]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            scales: {
                                x: { grid: { display: false }, ticks: { color: '#94a3b8' } },
                                y: { display: false },
                                yWealth: {
                                    position: 'right',
                                    grid: { color: '#334155' },
                                    ticks: { color: '#facc15', callback: v => v/1000 + 'k' }
                                }
                            },
                            plugins: {
                                legend: { labels: { color: 'white' } }
                            }
                        }
                    });
                },

                async saveRule() {
                    if(!this.form.name || !this.form.amount) return alert("Faltan datos");

                    const { error } = await db.from('recurring').insert([{
                        name: this.form.name,
                        amount: Number(this.form.amount),
                        type: this.form.type,
                        day_of_month: this.form.day_of_month || 1,
                        account_id: this.form.account_id
                    }]);

                    if(error) alert(error.message);
                    else {
                        this.showModal = false;
                        this.loadData();
                    }
                },

                async deleteRule(id) {
                    if(confirm("Â¿Borrar?")) {
                        await db.from('recurring').delete().eq('id', id);
                        this.loadData();
                    }
                },
                
                translateType(t) {
                    const dict = { 'expense': 'Gasto', 'income': 'Ingreso', 'transfer': 'Ahorro', 'investment': 'InversiÃ³n' };
                    return dict[t] || t;
                },
                formatMoney(n) { return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(n); }
            }
        }
    </script>
</body>
</html>
